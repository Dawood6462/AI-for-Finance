# Copyright 2022 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
main:
  params: [input]
  steps:
    - init:
        assign:
          - fileName: ${input.data.name}
          - bucket: ${input.data.bucket}
          - gsUri: ${"gs://" + bucket + "/" + fileName}
          - projectId: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
          - extractMetadataFunctionRegion: us-central1
          - extractMetadataFunctionName: extract-image-metadata
          - thumbnailQueueName: thumbnail-task-queue
          - thumbnailQueueLocation: us-central1
          - thumbnailServiceLocation: us-central1
          - thumbnailServiceName: create-thumbnail
    - imageAnalysisCall:
        call: http.post
        args:
          url: https://vision.googleapis.com/v1/images:annotate
          headers:
            Content-Type: application/json
          auth:
            type: OAuth2
          body:
            requests:
            - image:
                source:
                  gcsImageUri: ${gsUri}
              features:
              - type: SAFE_SEARCH_DETECTION
              - type: LABEL_DETECTION
              - type: DOCUMENT_TEXT_DETECTION
        result: imageAnalysisResponse
    - extractImageMetadata:
        call: http.post
        args:
          url: ${"https://" + extractMetadataFunctionRegion + "-" + projectId + ".cloudfunctions.net/" + extractMetadataFunctionName}
          auth:
            type: OIDC
          body: ${imageAnalysisResponse.body}
        result: imageMetadata
    - checkSafety:
        switch:
          - condition: ${imageMetadata.body.safe == true}
            next: storeMetadata
        next: end
    - storeMetadata:
        call: http.request
        args:
          url: ${"https://firestore.googleapis.com/v1/projects/" + projectId + "/databases/(default)/documents/images/" + fileName + "?updateMask.fieldPaths=labels&updateMask.fieldPaths=text&updateMask.fieldPaths=created"}
          auth:
            type: OAuth2
          method: PATCH
          body:
            name: ${"projects/" + projectId + "/databases/(default)/documents/images/" + fileName}
            fields:
              labels:
                arrayValue:
                  values: ${imageMetadata.body.labels}
              text:
                stringValue: ${imageMetadata.body.text}
              created:
                timestampValue: ${imageMetadata.body.created}
        result: storeMetadataResponse
    - getThumbnailService:
        call: googleapis.run.v1.namespaces.services.get
        args:
          name: ${"namespaces/" + projectId + "/services/" + thumbnailServiceName}
          location: thumbnailServiceLocation
        result: thumbnailServiceInfo
    - queueThumbnail:
        call: googleapis.cloudtasks.v2.projects.locations.queues.tasks.create
        args:
          parent: ${thumbnailQueueName}
          body:
            task:
              httpRequest:
                url: thumbNailServiceInfo.uri
                httpMethod: "POST"
                body:
                  gcsImageUri: ${gsUri}
        result: task
    - completed:
        return:
          imageAnalysisResponse: ${imageAnalysisResponse.body}
          imageMetadata: ${imageMetadata.body}
          storeMetadataResponse: ${storeMetadataResponse.body}
          task: ${task}
